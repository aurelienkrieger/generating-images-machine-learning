
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>Stable Diffusion ¬∑ HonKit</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 5.1.1">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="conditioning.html" />
    
    
    <link rel="prev" href="diffusion_models.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Lectures</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="./">
            
                <a href="./">
            
                    
                    1 ‚Äì Enter the Latent Space üöÄ
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="machine_learning.html">
            
                <a href="machine_learning.html">
            
                    
                    Machine Learning
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="diffusion_models.html">
            
                <a href="diffusion_models.html">
            
                    
                    Diffusion Models
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.1.3" data-path="stable_diffusion.html">
            
                <a href="stable_diffusion.html">
            
                    
                    Stable Diffusion
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="conditioning.html">
            
                <a href="conditioning.html">
            
                    
                    Conditioning
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.5" data-path="text_to_image.html">
            
                <a href="text_to_image.html">
            
                    
                    Text to Image
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="apps.html">
            
                <a href="apps.html">
            
                    
                    End-User Applications
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.7" data-path="prompt_engineering.html">
            
                <a href="prompt_engineering.html">
            
                    
                    Prompt Engineering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8" data-path="parameters.html">
            
                <a href="parameters.html">
            
                    
                    Parameters
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.8.1" data-path="resolution.html">
            
                <a href="resolution.html">
            
                    
                    Resolution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8.2" data-path="seed.html">
            
                <a href="seed.html">
            
                    
                    Seed
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8.3" data-path="batch.html">
            
                <a href="batch.html">
            
                    
                    Batch size
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8.4" data-path="samplers.html">
            
                <a href="samplers.html">
            
                    
                    Samplers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8.5" data-path="cfg.html">
            
                <a href="cfg.html">
            
                    
                    CFG scale
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../2‚Äìrefine_images/">
            
                <a href="../2‚Äìrefine_images/">
            
                    
                    2 ‚Äì Refine Images üé®
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="../2‚Äìrefine_images/models.html">
            
                <a href="../2‚Äìrefine_images/models.html">
            
                    
                    Models
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.2" data-path="../2‚Äìrefine_images/checkpoint_models.html">
            
                <a href="../2‚Äìrefine_images/checkpoint_models.html">
            
                    
                    Checkpoint Models
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3" data-path="../2‚Äìrefine_images/custom_models.html">
            
                <a href="../2‚Äìrefine_images/custom_models.html">
            
                    
                    Custom Models
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.4" data-path="../2‚Äìrefine_images/inpainting.html">
            
                <a href="../2‚Äìrefine_images/inpainting.html">
            
                    
                    Inpainting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.5" data-path="../2‚Äìrefine_images/outpainting.html">
            
                <a href="../2‚Äìrefine_images/outpainting.html">
            
                    
                    Outpainting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.6" data-path="../2‚Äìrefine_images/upscaling.md">
            
                <span>
            
                    
                    Upscaling
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../3‚Äìimage_compositing/">
            
                <a href="../3‚Äìimage_compositing/">
            
                    
                    3 ‚Äì Image Compositing üìê
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="../3‚Äìimage_compositing/image_to_image.html">
            
                <a href="../3‚Äìimage_compositing/image_to_image.html">
            
                    
                    Image to Image
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.2" data-path="../3‚Äìimage_compositing/inpainting.html">
            
                <a href="../3‚Äìimage_compositing/inpainting.html">
            
                    
                    Inpainting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.3" data-path="../3‚Äìimage_compositing/depth_to_image.html">
            
                <a href="../3‚Äìimage_compositing/depth_to_image.html">
            
                    
                    Depth to Image
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../4-model_training/">
            
                <a href="../4-model_training/">
            
                    
                    4 - Model Training üíæ
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.4.1" data-path="../4-model_training/model_training.html">
            
                <a href="../4-model_training/model_training.html">
            
                    
                    Model Training
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4.2" data-path="../4-model_training/embedding.html">
            
                <a href="../4-model_training/embedding.html">
            
                    
                    Embedding
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../5‚Äìextra_tips_animations/">
            
                <a href="../5‚Äìextra_tips_animations/">
            
                    
                    5 ‚Äì Extra tips & Animations üé•
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../6‚Äìfinal_presentations/">
            
                <a href="../6‚Äìfinal_presentations/">
            
                    
                    6 ‚Äì Final Presentations ‚ú®
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Resources</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../resources/articles.html">
            
                <a href="../resources/articles.html">
            
                    
                    Articles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../resources/apps.html">
            
                <a href="../resources/apps.html">
            
                    
                    End-User Applications
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../resources/prompt_engineering.html">
            
                <a href="../resources/prompt_engineering.html">
            
                    
                    Prompt Engineering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="../resources/models.html">
            
                <a href="../resources/models.html">
            
                    
                    Models
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="../resources/inpainting_outpainting.html">
            
                <a href="../resources/inpainting_outpainting.html">
            
                    
                    Inpainting / Outpainting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="../resources/model_training.html">
            
                <a href="../resources/model_training.html">
            
                    
                    Model Training
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Stable Diffusion</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="what-is-stable-diffusion">What is Stable Diffusion?</h1>
<p>In the simplest form, Stable Diffusion is a text-to-image model. Give it a text prompt. It will return an AI image matching the text.</p>
<p><br></p>
<p></p><figure>
  <img src="../assets/lecture/andrew-wong-SD.png" width="500px">
  <figcaption style="color:grey; font-style: italic;">Credit: Andrew Wong, 2023, &quot;How does Stable Diffusion work?&quot;</figcaption>
</figure>
<br><p></p>
<h2 id="forward-diffusion">Forward diffusion</h2>
<p>A forward diffusion process adds noise to a training image, gradually turning it into an uncharacteristic noise image. The forward process will turn any cat or dog image into a noise image. Eventually, you won‚Äôt be able to tell whether they are initially a dog or a cat.</p>
<p><br></p>
<p></p><figure>
  <img src="../assets/lecture/andrew-wong-forward-diffusion.webp" width="500px">
  <figcaption style="color:grey; font-style: italic;">Credit: Andrew Wong, 2023, &quot;How does Stable Diffusion work?&quot;</figcaption>
</figure>
<br><p></p>
<h2 id="reverse-diffusion">Reverse diffusion</h2>
<p>What if we can reverse the diffusion? Like playing a video backward. Going backward in time. Starting from a noisy, meaningless image, reverse diffusion recovers a cat.</p>
<h2 id="stable-diffusion-model-training">Stable Diffusion model training</h2>
<p>To reverse the diffusion, we need to know how much noise is added to an image. The answer is teaching a neural network model to predict the noise added. It is called the noise predictor in Stable Diffusion. The training goes as follows:</p>
<ol>
<li>Pick a training image, like a photo of a cat.</li>
<li>Generate a random noise image.</li>
<li>Corrupt the training image by adding this noisy image up to a certain number of steps.</li>
<li>Teach the noise predictor to tell us how much noise was added. This is done by tuning its weights and showing it the correct answer.</li>
</ol>
<p><br></p>
<p></p><figure>
  <img src="../assets/lecture/andrew-wong-diffusion-training.webp" width="500px">
  <figcaption style="color:grey; font-style: italic;">Credit: Andrew Wong, 2023, &quot;How does Stable Diffusion work?&quot;</figcaption>
</figure>
<br><p></p>
<p>Noise is sequentially added  and the noise predictor estimates the total noise added up to each step. After training, we have a noise predictor capable of estimating the noise added to an image.</p>
<h2 id="reverse-diffusion">Reverse diffusion</h2>
<p>Now we have the noise predictor. How to use it?</p>
<p>We first generate a completely random image and ask the noise predictor to tell us the noise. We then subtract this estimated noise from the original image. Repeat this process a few times. You will get an image of a cat.</p>
<p><br></p>
<p></p><figure>
  <img src="../assets/lecture/andrew-wong-reverse-training.png" width="500px">
  <figcaption style="color:grey; font-style: italic;">Credit: Andrew Wong, 2023, &quot;How does Stable Diffusion work?&quot;</figcaption>
</figure>
<br><p></p>
<p>For now, image generation is unconditioned. We will see how to apply conditioning to have control over the image generated.</p>
<h2 id="differences-between-diffusion-models-and-latent-diffusion-models">Differences between diffusion models and latent diffusion models</h2>
<p>The above diffusion process is in image space. It is computationally very, very slow because the image space is enormous. For instance, a 512√ó512 image with three color channels (red, green, and blue) is a 786,432-dimensional space. Diffusion models like Google‚Äôs Imagen and Open AI‚Äôs DALL-E are in pixel space. They have used some tricks to make the model faster but still not enough.</p>
<p>Stable Diffusion, on the other hand, is a latent diffusion model which is designed to solve the speed problem. Instead of operating in the high-dimensional image space, it first compresses the image into the latent space. The latent space is 48 times smaller so it reaps the benefit of crunching a lot fewer numbers. That‚Äôs why it‚Äôs a lot faster.</p>
<h2 id="variational-autoencoder">Variational Autoencoder</h2>
<p>It is done using a technique called the Variational Autoencoder (VAE). The VAE neural network has two parts: an encoder and a decoder. The encoder compresses an image to a lower dimensional representation in the latent space. The decoder restores the image from the latent space.</p>
<p><br></p>
<p></p><figure>
  <img src="../assets/lecture/andrew-wong-vae.png" width="500px">
  <figcaption style="color:grey; font-style: italic;">Credit: Andrew Wong, 2023, &quot;How does Stable Diffusion work?&quot;</figcaption>
</figure>
<br><p></p>
<p>The latent space of Stable Diffusion model is 4x64x64, 48 times smaller than the image pixel space. All the forward and reverse diffusions we talked about are actually done in the latent space.</p>
<p>The VAE decoder is also responsible for recovering fine details that may have been lost by the encoder. By further fine-tuning the VAE decoder, the model can paint finer details.</p>
<h2 id="reverse-diffusion-in-latent-space">Reverse diffusion in latent space</h2>
<p>Here‚Äôs how latent reverse diffusion in Stable Diffusion works.</p>
<ol>
<li>A random latent space matrix is generated.</li>
<li>The noise predictor estimates the noise of the latent matrix.</li>
<li>The estimated noise is then subtracted from the latent matrix.</li>
<li>Steps 2 and 3 are repeated up to specific sampling steps.</li>
<li>The decoder of VAE converts the latent matrix to the final image.</li>
</ol>
<p>Our understanding is incomplete: Where does the text prompt enter the picture? Without it, Stable Diffusion is not a text-to-image model. You will either get an image of a cat or a dog without any way to control it. This is where conditioning comes in.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://stable-diffusion-art.com/how-stable-diffusion-work/" target="_blank">Andrew Wong, 2023, &quot;How does Stable Diffusion work?&quot;, <em>Stable Diffusion Art</em></a></li>
<li><a href="https://bootcamp.uxdesign.cc/how-stable-diffusion-works-explained-for-non-technical-people-be6aa674fa1d" target="_blank">Guodong (Troy) Zhao, 2023, &quot;How Stable Diffusion works, explained for non-technical people&quot;, <em>Medium</em></a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="diffusion_models.html" class="navigation navigation-prev " aria-label="Previous page: Diffusion Models">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="conditioning.html" class="navigation navigation-next " aria-label="Next page: Conditioning">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Stable Diffusion","level":"2.1.3","depth":2,"next":{"title":"Conditioning","level":"2.1.4","depth":2,"path":"1‚Äìenter_the_latent_space/conditioning.md","ref":"1‚Äìenter_the_latent_space/conditioning.md","articles":[]},"previous":{"title":"Diffusion Models","level":"2.1.2","depth":2,"path":"1‚Äìenter_the_latent_space/diffusion_models.md","ref":"1‚Äìenter_the_latent_space/diffusion_models.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"1‚Äìenter_the_latent_space/stable_diffusion.md","mtime":"2023-10-19T17:05:01.124Z","type":"markdown"},"gitbook":{"version":"5.1.1","time":"2023-10-19T19:23:22.094Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

